import requests

# =========================
# CONFIGURAÇÃO
# =========================

API_KEY = ""
AUTH_LOG_PATH = "auth.log"
REPORT_FILE = "relatorio_final.txt"
BRUTEFORCE_THRESHOLD = 5

# =========================
# PARTE 1 — LEITURA DE LOGS
# =========================

def parse_auth_log(file_path):
    failed = {}

    with open(file_path, "r") as f:
        for line in f:
            if "Failed password" in line:
                try:
                    ip = line.split()[-4]
                    failed[ip] = failed.get(ip, 0) + 1
                except IndexError:
                    continue

    return failed


# =========================
# PARTE 2 — DETECÇÃO
# =========================

def detect_bruteforce(data, threshold):
    return {
        ip: count
        for ip, count in data.items()
        if count >= threshold
    }


# =========================
# PARTE 3 — VIRUSTOTAL
# =========================

def vt_lookup(ip, api_key):
    url = f"https://www.virustotal.com/api/v3/ip_addresses/{ip}"
    headers = {"x-apikey": api_key}

    try:
        response = requests.get(url, headers=headers, timeout=10)
        data = response.json()
        return data["data"]["attributes"]["last_analysis_stats"]
    except Exception as e:
        print(f"[ERRO] VirusTotal lookup falhou para {ip}: {e}")
        return None


# =========================
# PARTE 4 — CLASSIFICAÇÃO
# =========================

def classify_risk(stats):
    if stats["malicious"] > 0:
        return "ALTO"
    elif stats["suspicious"] > 0:
        return "MÉDIO"
    else:
        return "BAIXO"


# =========================
# PARTE 5 — RELATÓRIO SOC
# =========================

def write_report(ip, attempts, stats, risk):
    with open(REPORT_FILE, "a") as report:
        report.write("[ALERTA SOC – PRIORIDADE ")
        report.write("ALTA]\n\n" if risk == "ALTO" else "MÉDIA]\n\n")

        report.write("Tipo: BruteForce SSH\n")
        report.write(f"IP: {ip}\n")
        report.write(f"Tentativas falhas: {attempts}\n")
        report.write(
            f"Reputação VirusTotal: "
            f"malicious={stats['malicious']} | "
            f"suspicious={stats['suspicious']}\n"
        )
        report.write(f"Classificação: RISCO {risk}\n\n")

        report.write("Ação Recomendada:\n")

        if risk == "ALTO":
            report.write("- Bloqueio imediato no firewall\n")
            report.write("- Isolamento do host alvo\n")
            report.write("- Escalonamento para IR\n")
        elif risk == "MÉDIO":
            report.write("- Monitoramento contínuo\n")
            report.write("- Coleta de mais evidências\n")
        else:
            report.write("- Arquivamento para referência futura\n")

        report.write("\n" + "=" * 60 + "\n\n")


# =========================
# PARTE 6 — FLUXO PRINCIPAL
# =========================

def main():
    print("[+] Iniciando Detector SOC\n")

    failed_logins = parse_auth_log(AUTH_LOG_PATH)
    brute_force_ips = detect_bruteforce(
        failed_logins,
        BRUTEFORCE_THRESHOLD
    )

    if not brute_force_ips:
        print("Nenhum brute force detectado.")
        return

    for ip, attempts in brute_force_ips.items():
        print(f"[ALERTA] IP {ip} com {attempts} falhas")

        stats = vt_lookup(ip, API_KEY)

        if not stats:
            continue

        risk = classify_risk(stats)
        print(f"→ Classificação SOC: RISCO {risk}")

        write_report(ip, attempts, stats, risk)

    print("\n[+] Análise finalizada. Relatório gerado.")


# =========================
# EXECUÇÃO
# =========================

if __name__ == "__main__":
    main()

