import requests
import time

# ===============================
# CONFIGURAÇÃO
# ===============================

API_KEY = "65f0d8926ea72ab59694a2d229cbf7f5808fadddfa0b440f0778b7700bc8f478"
HEADERS = {"x-apikey": API_KEY}

INPUT_FILE = "iocs.txt"
OUTPUT_FILE = "relatorio_soc.txt"

# ===============================
# FUNÇÕES DE CONSULTA
# ===============================

def check_ip(ip):
    url = f"https://www.virustotal.com/api/v3/ip_addresses/{ip}"
    response = requests.get(url, headers=HEADERS)
    return response.json()

def check_domain(domain):
    url = f"https://www.virustotal.com/api/v3/domains/{domain}"
    response = requests.get(url, headers=HEADERS)
    return response.json()

def classify_ioc(stats):
    if stats.get("malicious", 0) > 0:
        return "MALICIOSO"
    elif stats.get("suspicious", 0) > 0:
        return "SUSPEITO"
    else:
        return "LIMPO"

# ===============================
# PROCESSAMENTO DOS IOCs
# ===============================

with open(INPUT_FILE, "r") as file, open(OUTPUT_FILE, "w") as report:
    report.write("=== RELATÓRIO SOC — VIRUSTOTAL ===\n\n")

    for line in file:
        ioc = line.strip()

        if not ioc:
            continue

        # Identifica se é IP ou domínio
        if ioc.replace(".", "").isdigit():
            ioc_type = "IP"
            data = check_ip(ioc)
        else:
            ioc_type = "DOMAIN"
            data = check_domain(ioc)

        # Extrai estatísticas
        try:
            stats = data["data"]["attributes"]["last_analysis_stats"]
            verdict = classify_ioc(stats)
        except KeyError:
            verdict = "ERRO NA CONSULTA"

        # Exibe no terminal
        print(f"{ioc_type}: {ioc} → {verdict}")

        # Grava no relatório
        report.write(f"{ioc_type}: {ioc}\n")
        report.write(f"Classificação: {verdict}\n")
        report.write(f"Detalhes: {stats if verdict != 'ERRO NA CONSULTA' else 'N/A'}\n")
        report.write("-" * 40 + "\n")

        # Respeita rate limit
        time.sleep(15)

print("\n✅ Análise finalizada. Relatório gerado em relatorio_soc.txt")

